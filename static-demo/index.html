<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WLeaks - Water Leak Detection System Demo</title>
    <meta name="description" content="IoT-based water leak detection and monitoring system simulation demo">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ============================================
           CSS Custom Properties (Design Tokens)
           ============================================ */
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2234;
            --bg-card: rgba(17, 24, 39, 0.85);
            --bg-card-hover: rgba(26, 34, 52, 0.95);
            --accent-primary: #06b6d4;
            --accent-secondary: #3b82f6;
            --accent-tertiary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --gradient-primary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border-primary: rgba(6, 182, 212, 0.2);
            --border-subtle: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-blur: blur(12px);
            --shadow-glow-cyan: 0 0 20px rgba(6, 182, 212, 0.3);
            --shadow-glow-red: 0 0 20px rgba(239, 68, 68, 0.4);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* Light Mode */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-card-hover: rgba(241, 245, 249, 0.98);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-primary: rgba(6, 182, 212, 0.3);
            --border-subtle: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --shadow-glow-cyan: 0 0 15px rgba(6, 182, 212, 0.15);
        }

        /* Light Mode - Cards */
        [data-theme="light"] .card {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--border-subtle);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        [data-theme="light"] .card-header {
            border-color: var(--border-subtle);
        }

        /* Light Mode - Chart Container */
        [data-theme="light"] .chart-container {
            background: #f8fafc;
            border-color: var(--border-subtle);
        }

        [data-theme="light"] .chart-container h4 {
            color: #0f172a;
        }

        /* Light Mode - Gauge Items */
        [data-theme="light"] .gauge-item {
            background: #f8fafc;
            border-color: var(--border-subtle);
        }

        [data-theme="light"] .gauge-label {
            color: #475569;
        }

        [data-theme="light"] .gauge-unit {
            color: #64748b;
        }

        /* Light Mode - System Status */
        [data-theme="light"] .system-status {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.08) 0%, rgba(255, 255, 255, 0.5) 100%);
        }

        [data-theme="light"] .system-status-label {
            color: #475569;
        }

        /* Light Mode - Error Table */
        [data-theme="light"] .error-table th {
            background: #e2e8f0;
            color: #0f172a;
        }

        [data-theme="light"] .error-table td {
            color: #475569;
            border-color: var(--border-subtle);
        }

        /* Light Mode - Demo Controls */
        [data-theme="light"] .demo-controls {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.25);
        }

        [data-theme="light"] .demo-controls-label {
            color: #7c3aed;
        }

        /* Light Mode - Sensor Cards */
        [data-theme="light"] .sensor-card::before {
            opacity: 0.8;
        }

        [data-theme="light"] .sensor-id {
            color: #64748b;
        }

        /* Light Mode - Nav Links */
        [data-theme="light"] .nav-link {
            color: #475569;
        }

        [data-theme="light"] .nav-link:hover,
        [data-theme="light"] .nav-link.active {
            color: #0891b2;
            background: rgba(6, 182, 212, 0.1);
        }

        /* Light Mode - Scenario Hint */
        [data-theme="light"] .scenario-hint {
            background: rgba(6, 182, 212, 0.08);
        }

        /* Light Mode - Buttons */
        [data-theme="light"] .btn-secondary {
            background: #e2e8f0;
            color: #475569;
            border-color: var(--border-subtle);
        }

        [data-theme="light"] .btn-secondary:hover:not(:disabled) {
            background: #cbd5e1;
        }

        [data-theme="light"] .btn-outline {
            color: #0891b2;
            border-color: #0891b2;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-primary);
            border-radius: 50%;
            background: var(--bg-card);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow-cyan);
        }

        .theme-icon {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.4s ease;
        }

        .theme-icon.sun {
            opacity: 0;
            transform: rotate(-90deg) scale(0.5);
        }

        .theme-icon.moon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="light"] .theme-icon.sun {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="light"] .theme-icon.moon {
            opacity: 0;
            transform: rotate(90deg) scale(0.5);
        }

        /* Theme Transitions */
        body,
        .navbar,
        .card,
        .btn,
        .gauge-item,
        .chart-container {
            transition: background-color 0.3s ease,
                color 0.3s ease,
                border-color 0.3s ease;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(6, 182, 212, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
        }

        /* Navigation */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem 1.5rem;
        }

        .navbar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            list-style: none;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 0.15s;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent-primary);
            background: rgba(6, 182, 212, 0.1);
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .page-header {
            text-align: center;
            padding: 2rem 0;
        }

        .page-header h1 {
            font-size: 2rem;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-header p {
            color: var(--text-secondary);
        }

        /* Grid */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            transition: all 0.25s;
        }

        .card:hover {
            background: var(--bg-card-hover);
            border-color: rgba(6, 182, 212, 0.3);
            box-shadow: var(--shadow-glow-cyan);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .card-error {
            border-color: var(--accent-danger);
        }

        .card-error.active {
            animation: glow-red 1.5s infinite;
        }

        @keyframes glow-red {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
            }
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: var(--shadow-glow-cyan);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(6, 182, 212, 0.1);
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 1rem;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-indicator .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .status-on {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
        }

        .status-on .dot {
            background: var(--accent-success);
            box-shadow: 0 0 10px var(--accent-success);
        }

        .status-off {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
        }

        .status-off .dot {
            background: var(--accent-danger);
            animation: none;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }

        .status-warning .dot {
            background: var(--accent-warning);
            animation: blink 0.5s infinite;
        }

        /* Demo Controls */
        .demo-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-bottom: 1.5rem;
        }

        .demo-controls-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
            color: var(--accent-tertiary);
            margin-bottom: 0.5rem;
        }

        .demo-controls .btn {
            flex: 1;
            min-width: 100px;
        }

        /* System Status */
        .system-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.05) 0%, transparent 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            margin-bottom: 1rem;
        }

        .system-status-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .system-status-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .text-success {
            color: var(--accent-success);
        }

        .text-danger {
            color: var(--accent-danger);
        }

        .text-warning {
            color: var(--accent-warning);
        }

        /* Water Flow Animation */
        .water-flow {
            position: relative;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: 1rem 0;
        }

        .water-flow::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            animation: flow 2s linear infinite;
        }

        .water-flow.paused::after {
            animation-play-state: paused;
            left: -100%;
        }

        .water-flow.slow::after {
            animation-duration: 4s;
        }

        @keyframes flow {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Charts */
        .chart-container {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
        }

        .chart-container h4 {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-wrapper {
            height: 200px;
        }

        /* Sensor Cards */
        .sensor-card {
            position: relative;
            overflow: hidden;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .sensor-card.sensor-warning::before {
            background: var(--gradient-danger);
        }

        .sensor-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sensor-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            color: white;
        }

        .sensor-name {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sensor-id {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Gauge Grid */
        .gauge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .gauge-item {
            text-align: center;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            transition: all 0.3s;
        }

        .gauge-item.warning {
            border-color: var(--accent-danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .gauge-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--accent-primary);
            transition: color 0.3s;
        }

        .gauge-value.zero {
            color: var(--text-muted);
        }

        .gauge-value.warning {
            color: var(--accent-danger);
        }

        .gauge-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .gauge-unit {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Error Table */
        .error-table {
            width: 100%;
            border-collapse: collapse;
        }

        .error-table th,
        .error-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .error-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
        }

        .error-type-leak {
            color: var(--accent-danger);
        }

        .error-type-blockage {
            color: var(--accent-warning);
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .mt-2 {
            margin-top: 1rem;
        }

        /* Scenario Hint */
        .scenario-hint {
            padding: 0.75rem 1rem;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: none;
        }

        .scenario-hint.visible {
            display: block;
        }

        .scenario-hint.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--accent-warning);
        }

        .scenario-hint.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .navbar-inner {
                flex-direction: column;
                gap: 1rem;
            }

            .gauge-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="#" class="navbar-brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                </svg>
                WLeaks
            </a>
            <ul class="nav-links">
                <li><a href="setup.html" class="nav-link">Hardware Setup</a></li>
                <li><a href="https://github.com/blamairia/wleaks" class="nav-link" target="_blank">GitHub</a></li>
            </ul>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <span class="theme-icon sun">‚òÄÔ∏è</span>
                <span class="theme-icon moon">üåô</span>
            </button>
        </div>
    </nav>

    <main class="container">
        <!-- Page Header -->
        <header class="page-header">
            <h1>üíß Water Leak Detection System</h1>
            <p>Real-time IoT monitoring with automated pump shutoff ‚Äî Interactive Demo</p>
        </header>

        <!-- Scenario Hint -->
        <div id="scenario-hint" class="scenario-hint"></div>

        <!-- Demo Controls -->
        <div class="demo-controls">
            <span class="demo-controls-label">
                <i data-lucide="wand-2"></i>
                Demo Controls ‚Äî Try triggering scenarios!
            </span>
            <button id="btn-leak" class="btn btn-outline btn-sm" onclick="triggerLeak()">
                <i data-lucide="droplets"></i> Trigger Leak
            </button>
            <button id="btn-blockage" class="btn btn-outline btn-sm" onclick="triggerBlockage()">
                <i data-lucide="octagon-x"></i> Trigger Blockage
            </button>
            <button class="btn btn-primary btn-sm" onclick="resetDemo()">
                <i data-lucide="refresh-cw"></i> Reset
            </button>
        </div>

        <!-- Main Grid -->
        <div class="grid-3">
            <!-- System Control -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Control</h2>
                    <div id="system-status" class="status-indicator status-on">
                        <span class="dot"></span>
                        <span id="status-text">Running</span>
                    </div>
                </div>

                <div class="system-status">
                    <div>
                        <div class="system-status-label">Pump Status</div>
                        <div id="pump-status" class="system-status-value text-success">ON</div>
                    </div>
                    <button id="toggle-btn" class="btn btn-primary" onclick="toggleSystem()">
                        <i data-lucide="power"></i> Toggle
                    </button>
                </div>

                <h4
                    style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.5rem;">
                    Water Flow</h4>
                <div id="water-flow" class="water-flow"></div>

                <div class="system-status">
                    <div>
                        <div class="system-status-label">Error Status</div>
                        <div id="error-status-text" class="system-status-value text-success">OK</div>
                    </div>
                    <div id="error-indicator" class="status-indicator status-on">
                        <span class="dot"></span>
                        <span>Normal</span>
                    </div>
                </div>
            </div>

            <!-- Live Metrics -->
            <div class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon"><i data-lucide="activity"></i></div>
                    <div>
                        <div class="sensor-name">Live Metrics</div>
                        <div class="sensor-id">Averaged across all sensors</div>
                    </div>
                </div>
                <div class="chart-container">
                    <h4>Flow Rate (L/min)</h4>
                    <div id="flowrate-chart" class="chart-wrapper"></div>
                </div>
                <div class="chart-container">
                    <h4>Volume (L)</h4>
                    <div id="volume-chart" class="chart-wrapper"></div>
                </div>
            </div>

            <!-- Error Log -->
            <div id="error-log-card" class="card">
                <div class="card-header">
                    <h2 class="card-title">Error Log</h2>
                    <span id="error-count" class="status-indicator status-on">
                        <span class="dot"></span>
                        <span>0 errors</span>
                    </span>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="error-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="error-table-body">
                            <tr>
                                <td colspan="2" class="text-center text-muted">No errors recorded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sensor Row -->
        <div class="grid-3 mt-2">
            <div id="sensor-card-1" class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon"><i data-lucide="gauge"></i></div>
                    <div>
                        <div class="sensor-name">Sensor 1</div>
                        <div class="sensor-id">Entry Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div id="gauge-s1-flow" class="gauge-item">
                        <div id="s1-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div id="gauge-s1-pulse" class="gauge-item">
                        <div id="s1-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div id="gauge-s1-volume" class="gauge-item">
                        <div id="s1-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>

            <div id="sensor-card-2" class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"><i
                            data-lucide="gauge"></i></div>
                    <div>
                        <div class="sensor-name">Sensor 2</div>
                        <div class="sensor-id">Mid Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div id="gauge-s2-flow" class="gauge-item">
                        <div id="s2-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div id="gauge-s2-pulse" class="gauge-item">
                        <div id="s2-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div id="gauge-s2-volume" class="gauge-item">
                        <div id="s2-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>

            <div id="sensor-card-3" class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i
                            data-lucide="gauge"></i></div>
                    <div>
                        <div class="sensor-name">Sensor 3</div>
                        <div class="sensor-id">Exit Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div id="gauge-s3-flow" class="gauge-item">
                        <div id="s3-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div id="gauge-s3-pulse" class="gauge-item">
                        <div id="s3-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div id="gauge-s3-volume" class="gauge-item">
                        <div id="s3-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ============================================
        // CLIENT-SIDE SIMULATOR (No server needed!)
        // Comprehensive edge case handling
        // ============================================
        const calibrationFactors = [342.5, 314, 438.5];
        const baseFlowRate = 2.5;

        // System state
        let systemState = true;
        let scenario = 'normal'; // 'normal', 'leak', 'blockage'
        let scenarioStartTime = null;
        let errorDetected = false;
        let leakDetected = false;
        let blockageDetected = false;
        let errors = [];
        let volumes = [0, 0, 0];
        let lastFlowRates = [0, 0, 0];

        // Timing
        let startupTime = Date.now();
        let shutdownTime = null;
        const startupDuration = 2000; // 2s to reach full flow
        const shutdownDuration = 1000; // 1s for residual flow
        const detectionDelay = 3000; // 3s before error triggers

        // Chart instances
        let flowRateChart, volumeChart;
        const chartData = { flowRate: [], volume: [] };
        const maxDataPoints = 30;

        // ============================================
        // Edge Case: Startup/Shutdown Transients
        // ============================================
        function getTransientMultiplier() {
            const now = Date.now();

            // Gradual startup ramp (ease-out curve)
            if (systemState && startupTime) {
                const elapsed = now - startupTime;
                if (elapsed < startupDuration) {
                    // Ease-out: starts fast, slows down
                    const progress = elapsed / startupDuration;
                    return 1 - Math.pow(1 - progress, 3);
                }
            }

            // Gradual shutdown decay (only for first second after shutdown)
            if (!systemState && shutdownTime) {
                const elapsed = now - shutdownTime;
                if (elapsed < shutdownDuration) {
                    // Exponential decay
                    return Math.max(0, 1 - (elapsed / shutdownDuration));
                }
                return 0;
            }

            return systemState ? 1.0 : 0;
        }

        // ============================================
        // Simulator Logic with Edge Cases
        // ============================================
        function generateSensorData() {
            const transientMultiplier = getTransientMultiplier();
            const time = Date.now() / 1000;
            const sensors = [];

            for (let i = 0; i < 3; i++) {
                // Base calculations only if system is supposed to flow
                let flowRate = 0;

                if (transientMultiplier > 0) {
                    // Base flow with pump pulsation
                    const pumpVariation = Math.sin(time * Math.PI) * 0.1;
                    const noise = (Math.random() - 0.5) * 0.3;
                    const sensorOffset = [0, -0.05, 0.03][i];
                    const drift = Math.sin(time * 0.01) * 0.05;

                    flowRate = Math.max(0, baseFlowRate + pumpVariation + noise + sensorOffset + drift);

                    // Apply scenario modifications
                    if (scenario === 'leak') {
                        if (i === 1) flowRate *= 0.4;
                        else if (i === 2) flowRate *= 0.35;
                    } else if (scenario === 'blockage') {
                        if (i === 0) flowRate *= 1.05; // Back-pressure
                        else if (i === 1) flowRate *= 0.95;
                        else if (i === 2) flowRate *= 0.02;
                    }

                    // Apply transient
                    flowRate *= transientMultiplier;
                }

                // Calculate derived values
                const pulseCount = flowRate > 0 ? Math.round((flowRate / 60) * calibrationFactors[i]) : 0;

                // Volume only accumulates when flowing
                if (systemState && flowRate > 0) {
                    volumes[i] += flowRate / 60;
                }

                lastFlowRates[i] = flowRate;
                sensors.push({ flowRate, pulseCount, volume: volumes[i] });
            }

            return sensors;
        }

        function checkForErrors(sensors) {
            // Can't detect errors if system is off
            if (!systemState || errorDetected) return;

            // Start detection timer when scenario begins
            if (scenario !== 'normal' && !scenarioStartTime) {
                scenarioStartTime = Date.now();
            }

            // Check after detection delay
            if (scenarioStartTime && Date.now() - scenarioStartTime >= detectionDelay) {
                errorDetected = true;
                systemState = false;
                shutdownTime = Date.now();
                startupTime = null;

                if (scenario === 'leak') {
                    leakDetected = true;
                    errors.unshift({
                        type: 'Leak Detected',
                        details: 'Flow rate difference >50% between sensors. Emergency shutdown.',
                        time: new Date()
                    });
                } else if (scenario === 'blockage') {
                    blockageDetected = true;
                    errors.unshift({
                        type: 'Blockage Detected',
                        details: 'Exit sensor reading <0.1 L/min while pump running. Emergency shutdown.',
                        time: new Date()
                    });
                }

                updateErrorDisplay();
                updateSystemDisplay();
                updateScenarioHint();
            }
        }

        // ============================================
        // UI Updates with Edge Case Handling
        // ============================================
        function updateSystemDisplay() {
            const statusEl = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            const pumpStatus = document.getElementById('pump-status');
            const waterFlow = document.getElementById('water-flow');
            const toggleBtn = document.getElementById('toggle-btn');
            const btnLeak = document.getElementById('btn-leak');
            const btnBlockage = document.getElementById('btn-blockage');

            if (systemState) {
                statusEl.className = 'status-indicator status-on';
                statusText.textContent = 'Running';
                pumpStatus.textContent = 'ON';
                pumpStatus.className = 'system-status-value text-success';
                waterFlow.classList.remove('paused');

                // Check if in error scenario (but not yet detected)
                if (scenario !== 'normal') {
                    waterFlow.classList.add('slow');
                } else {
                    waterFlow.classList.remove('slow');
                }

                btnLeak.disabled = false;
                btnBlockage.disabled = false;
            } else {
                statusEl.className = 'status-indicator status-off';
                statusText.textContent = 'Stopped';
                pumpStatus.textContent = 'OFF';
                pumpStatus.className = 'system-status-value text-danger';
                waterFlow.classList.add('paused');
                waterFlow.classList.remove('slow');

                // Disable scenario buttons when system is off
                btnLeak.disabled = true;
                btnBlockage.disabled = true;
            }

            // Error indicator
            const errorIndicator = document.getElementById('error-indicator');
            const errorStatusText = document.getElementById('error-status-text');
            const errorCard = document.getElementById('error-log-card');

            if (leakDetected) {
                errorIndicator.className = 'status-indicator status-warning';
                errorIndicator.querySelector('span:last-child').textContent = 'LEAK!';
                errorStatusText.textContent = 'LEAK';
                errorStatusText.className = 'system-status-value text-danger';
                errorCard.classList.add('card-error', 'active');
            } else if (blockageDetected) {
                errorIndicator.className = 'status-indicator status-warning';
                errorIndicator.querySelector('span:last-child').textContent = 'BLOCKED!';
                errorStatusText.textContent = 'BLOCKAGE';
                errorStatusText.className = 'system-status-value text-warning';
                errorCard.classList.add('card-error', 'active');
            } else {
                errorIndicator.className = 'status-indicator status-on';
                errorIndicator.querySelector('span:last-child').textContent = 'Normal';
                errorStatusText.textContent = 'OK';
                errorStatusText.className = 'system-status-value text-success';
                errorCard.classList.remove('card-error', 'active');
            }
        }

        function updateScenarioHint() {
            const hint = document.getElementById('scenario-hint');

            if (!systemState && !errorDetected) {
                hint.className = 'scenario-hint visible';
                hint.innerHTML = '<strong>üí° Pump is OFF</strong> ‚Äî All sensors read 0. Volume is frozen. Click Toggle or Reset to restart.';
            } else if (scenario === 'leak' && !leakDetected) {
                hint.className = 'scenario-hint visible warning';
                hint.innerHTML = `<strong>‚ö†Ô∏è Leak Scenario Active</strong> ‚Äî Detecting flow difference... (${Math.min(100, Math.round((Date.now() - scenarioStartTime) / detectionDelay * 100))}%)`;
            } else if (scenario === 'blockage' && !blockageDetected) {
                hint.className = 'scenario-hint visible warning';
                hint.innerHTML = `<strong>‚ö†Ô∏è Blockage Scenario Active</strong> ‚Äî Detecting low exit flow... (${Math.min(100, Math.round((Date.now() - scenarioStartTime) / detectionDelay * 100))}%)`;
            } else if (leakDetected) {
                hint.className = 'scenario-hint visible danger';
                hint.innerHTML = '<strong>üö® LEAK DETECTED!</strong> ‚Äî Emergency shutdown triggered. Pump stopped. Click Reset to clear.';
            } else if (blockageDetected) {
                hint.className = 'scenario-hint visible danger';
                hint.innerHTML = '<strong>üö® BLOCKAGE DETECTED!</strong> ‚Äî Emergency shutdown triggered. Pump stopped. Click Reset to clear.';
            } else {
                hint.className = 'scenario-hint';
            }
        }

        function updateErrorDisplay() {
            const tbody = document.getElementById('error-table-body');
            const errorCount = document.getElementById('error-count');

            if (errors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No errors recorded</td></tr>';
                errorCount.querySelector('span:last-child').textContent = '0 errors';
                errorCount.className = 'status-indicator status-on';
            } else {
                tbody.innerHTML = errors.slice(0, 10).map(e => `
                    <tr>
                        <td class="${e.type.includes('Leak') ? 'error-type-leak' : 'error-type-blockage'}">
                            <strong>${e.type}</strong>
                        </td>
                        <td>
                            <div class="text-muted" style="font-size: 0.75rem;">${e.time.toLocaleTimeString()}</div>
                            <div>${e.details}</div>
                        </td>
                    </tr>
                `).join('');
                errorCount.querySelector('span:last-child').textContent = `${errors.length} error${errors.length > 1 ? 's' : ''}`;
                errorCount.className = 'status-indicator status-warning';
            }
        }

        function updateSensorDisplays(sensors) {
            for (let i = 0; i < 3; i++) {
                const flowEl = document.getElementById(`s${i + 1}-flow`);
                const pulseEl = document.getElementById(`s${i + 1}-pulse`);
                const volumeEl = document.getElementById(`s${i + 1}-volume`);
                const gaugeFlow = document.getElementById(`gauge-s${i + 1}-flow`);
                const sensorCard = document.getElementById(`sensor-card-${i + 1}`);

                flowEl.textContent = sensors[i].flowRate.toFixed(2);
                pulseEl.textContent = sensors[i].pulseCount;
                volumeEl.textContent = sensors[i].volume.toFixed(2);

                // Visual feedback for zero readings
                if (sensors[i].flowRate < 0.1) {
                    flowEl.classList.add('zero');
                    pulseEl.classList.add('zero');
                } else {
                    flowEl.classList.remove('zero');
                    pulseEl.classList.remove('zero');
                }

                // Warning styling for affected sensors in error scenarios
                const isAffected = (scenario === 'leak' && i >= 1) || (scenario === 'blockage' && i === 2);
                if (isAffected && sensors[i].flowRate < baseFlowRate * 0.5) {
                    gaugeFlow.classList.add('warning');
                    flowEl.classList.add('warning');
                    sensorCard.classList.add('sensor-warning');
                } else {
                    gaugeFlow.classList.remove('warning');
                    flowEl.classList.remove('warning');
                    sensorCard.classList.remove('sensor-warning');
                }
            }

            // Update charts
            const timestamp = new Date().getTime();
            const avgFlow = sensors.reduce((a, s) => a + s.flowRate, 0) / 3;
            const avgVol = sensors.reduce((a, s) => a + s.volume, 0) / 3;

            chartData.flowRate.push([timestamp, parseFloat(avgFlow.toFixed(2))]);
            chartData.volume.push([timestamp, parseFloat(avgVol.toFixed(2))]);

            if (chartData.flowRate.length > maxDataPoints) {
                chartData.flowRate.shift();
                chartData.volume.shift();
            }

            flowRateChart.updateSeries([{ data: chartData.flowRate }]);
            volumeChart.updateSeries([{ data: chartData.volume }]);
        }

        // ============================================
        // Demo Controls with Edge Case Handling
        // ============================================
        function triggerLeak() {
            // Can only trigger when system is ON and no error
            if (!systemState || errorDetected) return;

            scenario = 'leak';
            scenarioStartTime = Date.now();
            updateScenarioHint();
        }

        function triggerBlockage() {
            // Can only trigger when system is ON and no error
            if (!systemState || errorDetected) return;

            scenario = 'blockage';
            scenarioStartTime = Date.now();
            updateScenarioHint();
        }

        function resetDemo() {
            // Clear all error states
            scenario = 'normal';
            scenarioStartTime = null;
            errorDetected = false;
            leakDetected = false;
            blockageDetected = false;

            // Restart system
            systemState = true;
            startupTime = Date.now();
            shutdownTime = null;

            updateSystemDisplay();
            updateScenarioHint();
        }

        function toggleSystem() {
            if (systemState) {
                // Turning OFF
                systemState = false;
                shutdownTime = Date.now();
                startupTime = null;

                // Clear any pending scenarios but keep error history
                if (!errorDetected) {
                    scenario = 'normal';
                    scenarioStartTime = null;
                }
            } else {
                // Turning ON - clears error states (like pressing reset button on real hardware)
                systemState = true;
                startupTime = Date.now();
                shutdownTime = null;

                // Clear error states on manual restart
                scenario = 'normal';
                scenarioStartTime = null;
                errorDetected = false;
                leakDetected = false;
                blockageDetected = false;
            }

            updateSystemDisplay();
            updateScenarioHint();
        }

        // ============================================
        // Chart Initialization
        // ============================================
        function initCharts() {
            const chartOptions = {
                chart: {
                    type: 'area',
                    height: 180,
                    animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 1000 } },
                    toolbar: { show: false },
                    background: 'transparent',
                    fontFamily: 'Inter, sans-serif'
                },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2 },
                fill: {
                    type: 'gradient',
                    gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1, stops: [0, 90, 100] }
                },
                grid: { borderColor: 'rgba(255,255,255,0.1)', strokeDashArray: 3 },
                xaxis: { type: 'datetime', labels: { style: { colors: '#9ca3af' } } },
                yaxis: { labels: { style: { colors: '#9ca3af' } } },
                tooltip: { theme: 'dark' }
            };

            flowRateChart = new ApexCharts(document.getElementById('flowrate-chart'), {
                ...chartOptions,
                series: [{ name: 'Flow Rate', data: [] }],
                colors: ['#06b6d4']
            });
            flowRateChart.render();

            volumeChart = new ApexCharts(document.getElementById('volume-chart'), {
                ...chartOptions,
                series: [{ name: 'Volume', data: [] }],
                colors: ['#10b981']
            });
            volumeChart.render();
        }

        // ============================================
        // Main Loop
        // ============================================
        function tick() {
            const sensors = generateSensorData();
            updateSensorDisplays(sensors);
            checkForErrors(sensors);

            // Update hint for progress indication
            if (scenarioStartTime && !errorDetected) {
                updateScenarioHint();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateSystemDisplay();
            setInterval(tick, 1000);

            // Theme Controller
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('wleaks-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Set initial theme
            document.documentElement.setAttribute('data-theme',
                savedTheme || (prefersDark ? 'dark' : 'light')
            );

            // Toggle handler
            themeToggle.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('wleaks-theme', next);
            });
        });
    </script>
</body>

</html>