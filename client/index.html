<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WLeaks - Water Leak Detection System</title>
    <meta name="description"
        content="IoT-based water leak detection and monitoring system with real-time sensor data visualization">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="css/theme.css">

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="index.html" class="navbar-brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                </svg>
                WLeaks
            </a>
            <ul class="navbar-nav">
                <li><a href="index.html" class="nav-link active">Dashboard</a></li>
                <li><a href="sensors-real-time.html" class="nav-link">Real-Time</a></li>
                <li><a href="sensors-history.html" class="nav-link">History</a></li>
            </ul>
        </div>
    </nav>

    <main class="container-fluid">
        <!-- Page Header -->
        <header class="page-header">
            <h1>Water Leak Detection Dashboard</h1>
            <p>Real-time monitoring and automated leak detection for water distribution systems</p>
        </header>

        <!-- Demo Controls (visible in demo mode) -->
        <div id="demo-controls" class="demo-controls hidden">
            <span class="demo-controls-label">
                <i data-lucide="wand-2"></i>
                Demo Mode Controls
            </span>
            <button class="btn btn-outline btn-sm" onclick="triggerLeak()">
                <i data-lucide="droplets"></i> Trigger Leak
            </button>
            <button class="btn btn-outline btn-sm" onclick="triggerBlockage()">
                <i data-lucide="octagon-x"></i> Trigger Blockage
            </button>
            <button class="btn btn-primary btn-sm" onclick="resetDemo()">
                <i data-lucide="refresh-cw"></i> Reset
            </button>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="row row-3">
            <!-- Column 1: System Control -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Control</h2>
                    <div id="system-status" class="status-indicator status-off">
                        <span class="dot"></span>
                        <span id="status-text">Loading...</span>
                    </div>
                </div>

                <div class="control-panel">
                    <div class="system-status">
                        <div>
                            <div class="system-status-label">Pump Status</div>
                            <div id="pump-status" class="system-status-value">--</div>
                        </div>
                        <button id="switch-btn" class="btn btn-primary" onclick="switchSystemState()">
                            <i data-lucide="power"></i>
                            Toggle
                        </button>
                    </div>

                    <!-- Water Flow Animation -->
                    <div>
                        <h4>Water Flow</h4>
                        <div id="water-flow" class="water-flow paused"></div>
                    </div>

                    <!-- Error Status -->
                    <div id="error-status-card" class="system-status">
                        <div>
                            <div class="system-status-label">Error Status</div>
                            <div id="error-status-text" class="system-status-value text-success">OK</div>
                        </div>
                        <div id="error-indicator" class="status-indicator status-on">
                            <span class="dot"></span>
                            <span>Normal</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Real-Time Median Charts -->
            <div class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <i data-lucide="activity"></i>
                    </div>
                    <div>
                        <div class="sensor-name">Live Metrics</div>
                        <div class="sensor-id">Averaged across all sensors</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>Flow Rate (L/min)</h4>
                    <div id="median-flowrate-chart" class="chart-wrapper"></div>
                </div>

                <div class="chart-container">
                    <h4>Pulse Count</h4>
                    <div id="median-pulse-chart" class="chart-wrapper"></div>
                </div>

                <div class="chart-container">
                    <h4>Volume (L)</h4>
                    <div id="median-volume-chart" class="chart-wrapper"></div>
                </div>
            </div>

            <!-- Column 3: Error Log -->
            <div id="error-log-card" class="card">
                <div class="card-header">
                    <h2 class="card-title">Error Log</h2>
                    <span id="error-count" class="status-indicator status-on">
                        <span class="dot"></span>
                        <span>0 errors</span>
                    </span>
                </div>

                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="error-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="error-table-body">
                            <tr>
                                <td colspan="2" class="text-center text-muted">No errors recorded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sensor Overview Row -->
        <div class="row row-3 mt-3">
            <div class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <i data-lucide="gauge"></i>
                    </div>
                    <div>
                        <div class="sensor-name">Sensor 1</div>
                        <div class="sensor-id">Entry Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div class="gauge-item">
                        <div id="sensor1-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow Rate</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor1-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor1-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>

            <div class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <i data-lucide="gauge"></i>
                    </div>
                    <div>
                        <div class="sensor-name">Sensor 2</div>
                        <div class="sensor-id">Mid Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div class="gauge-item">
                        <div id="sensor2-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow Rate</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor2-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor2-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>

            <div class="card sensor-card">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <i data-lucide="gauge"></i>
                    </div>
                    <div>
                        <div class="sensor-name">Sensor 3</div>
                        <div class="sensor-id">Exit Point</div>
                    </div>
                </div>
                <div class="gauge-grid">
                    <div class="gauge-item">
                        <div id="sensor3-flow" class="gauge-value">0.00</div>
                        <div class="gauge-label">Flow Rate</div>
                        <div class="gauge-unit">L/min</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor3-pulse" class="gauge-value">0</div>
                        <div class="gauge-label">Pulses</div>
                        <div class="gauge-unit">/sec</div>
                    </div>
                    <div class="gauge-item">
                        <div id="sensor3-volume" class="gauge-value">0.00</div>
                        <div class="gauge-label">Volume</div>
                        <div class="gauge-unit">L</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Socket.IO connection
        const socket = io();

        // Chart instances
        let flowRateChart, pulseChart, volumeChart;

        // Chart data storage
        const maxDataPoints = 30;
        const chartData = {
            flowRate: [],
            pulse: [],
            volume: [],
            timestamps: []
        };

        // ============================================
        // Chart Initialization
        // ============================================
        function initCharts() {
            const chartOptions = {
                chart: {
                    type: 'area',
                    height: 180,
                    animations: {
                        enabled: true,
                        easing: 'linear',
                        dynamicAnimation: { speed: 1000 }
                    },
                    toolbar: { show: false },
                    background: 'transparent',
                    fontFamily: 'Inter, sans-serif'
                },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2 },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.4,
                        opacityTo: 0.1,
                        stops: [0, 90, 100]
                    }
                },
                grid: {
                    borderColor: 'rgba(255,255,255,0.1)',
                    strokeDashArray: 3
                },
                xaxis: {
                    type: 'datetime',
                    labels: { style: { colors: '#9ca3af' } }
                },
                yaxis: {
                    labels: { style: { colors: '#9ca3af' } }
                },
                tooltip: { theme: 'dark' }
            };

            // Flow Rate Chart
            flowRateChart = new ApexCharts(document.getElementById('median-flowrate-chart'), {
                ...chartOptions,
                series: [{ name: 'Flow Rate', data: [] }],
                colors: ['#06b6d4']
            });
            flowRateChart.render();

            // Pulse Chart
            pulseChart = new ApexCharts(document.getElementById('median-pulse-chart'), {
                ...chartOptions,
                series: [{ name: 'Pulse Count', data: [] }],
                colors: ['#3b82f6']
            });
            pulseChart.render();

            // Volume Chart
            volumeChart = new ApexCharts(document.getElementById('median-volume-chart'), {
                ...chartOptions,
                series: [{ name: 'Volume', data: [] }],
                colors: ['#10b981']
            });
            volumeChart.render();
        }

        // ============================================
        // Real-time Data Updates
        // ============================================
        socket.on('realtime-median-data', (data) => {
            const timestamp = new Date().getTime();

            // Update chart data
            chartData.flowRate.push([timestamp, data.flowRate.toFixed(2)]);
            chartData.pulse.push([timestamp, data.pulseCount]);
            chartData.volume.push([timestamp, data.volume.toFixed(2)]);

            // Limit data points
            if (chartData.flowRate.length > maxDataPoints) {
                chartData.flowRate.shift();
                chartData.pulse.shift();
                chartData.volume.shift();
            }

            // Update charts
            flowRateChart.updateSeries([{ data: chartData.flowRate }]);
            pulseChart.updateSeries([{ data: chartData.pulse }]);
            volumeChart.updateSeries([{ data: chartData.volume }]);
        });

        socket.on('realtime-data', (data) => {
            const sensorNum = data.sensorId + 1;
            document.getElementById(`sensor${sensorNum}-flow`).textContent = data.flowRate.toFixed(2);
            document.getElementById(`sensor${sensorNum}-pulse`).textContent = data.pulseCount;
            document.getElementById(`sensor${sensorNum}-volume`).textContent = data.volume.toFixed(2);
        });

        socket.on('system-state', (state) => {
            updateSystemState(state);
        });

        socket.on('error-detected', (error) => {
            showError(error);
            fetchErrors();
        });

        socket.on('system-reset', () => {
            clearErrors();
        });

        // ============================================
        // System State Management
        // ============================================
        function fetchSystemState() {
            fetch('/system/state')
                .then(res => res.json())
                .then(data => {
                    updateSystemState(data.state);
                    if (data.demoMode) {
                        document.getElementById('demo-controls').classList.remove('hidden');
                    }
                })
                .catch(err => console.error('Error fetching system state:', err));
        }

        function updateSystemState(state) {
            const statusEl = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            const pumpStatus = document.getElementById('pump-status');
            const waterFlow = document.getElementById('water-flow');

            if (state === 'ON') {
                statusEl.className = 'status-indicator status-on';
                statusText.textContent = 'Running';
                pumpStatus.textContent = 'ON';
                pumpStatus.className = 'system-status-value text-success';
                waterFlow.classList.remove('paused');
            } else {
                statusEl.className = 'status-indicator status-off';
                statusText.textContent = 'Stopped';
                pumpStatus.textContent = 'OFF';
                pumpStatus.className = 'system-status-value text-danger';
                waterFlow.classList.add('paused');
            }
        }

        function switchSystemState() {
            fetch('/system/switch', { method: 'POST' })
                .then(res => res.json())
                .then(() => setTimeout(fetchSystemState, 200))
                .catch(err => console.error('Error switching state:', err));
        }

        // ============================================
        // Error Management
        // ============================================
        function fetchDetectionStatus() {
            fetch('/detection_status')
                .then(res => res.json())
                .then(data => {
                    const errorIndicator = document.getElementById('error-indicator');
                    const errorStatusText = document.getElementById('error-status-text');
                    const errorCard = document.getElementById('error-log-card');

                    if (data.leakDetected) {
                        errorIndicator.className = 'status-indicator status-warning';
                        errorIndicator.querySelector('span:last-child').textContent = 'Leak!';
                        errorStatusText.textContent = 'LEAK';
                        errorStatusText.className = 'system-status-value text-danger';
                        errorCard.classList.add('card-error', 'active');
                    } else if (data.blockageDetected) {
                        errorIndicator.className = 'status-indicator status-warning';
                        errorIndicator.querySelector('span:last-child').textContent = 'Blockage!';
                        errorStatusText.textContent = 'BLOCKAGE';
                        errorStatusText.className = 'system-status-value text-warning';
                        errorCard.classList.add('card-error', 'active');
                    } else {
                        errorIndicator.className = 'status-indicator status-on';
                        errorIndicator.querySelector('span:last-child').textContent = 'Normal';
                        errorStatusText.textContent = 'OK';
                        errorStatusText.className = 'system-status-value text-success';
                        errorCard.classList.remove('card-error', 'active');
                    }
                })
                .catch(err => console.error('Error fetching detection status:', err));
        }

        function fetchErrors() {
            fetch('/errors')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('error-table-body');
                    const errorCount = document.getElementById('error-count');

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No errors recorded</td></tr>';
                        errorCount.querySelector('span:last-child').textContent = '0 errors';
                        errorCount.className = 'status-indicator status-on';
                    } else {
                        tbody.innerHTML = data.map(error => `
                            <tr>
                                <td class="${error.error_type.includes('Leak') ? 'error-type-leak' : 'error-type-blockage'}">
                                    <strong>${error.error_type}</strong>
                                </td>
                                <td>
                                    <div class="text-muted" style="font-size: 0.75rem;">${new Date(error.timestamp).toLocaleString()}</div>
                                    <div>${error.details}</div>
                                </td>
                            </tr>
                        `).join('');
                        errorCount.querySelector('span:last-child').textContent = `${data.length} error${data.length > 1 ? 's' : ''}`;
                        errorCount.className = 'status-indicator status-warning';
                    }
                })
                .catch(err => console.error('Error fetching errors:', err));
        }

        function showError(error) {
            const errorCard = document.getElementById('error-log-card');
            errorCard.classList.add('alert-shake');
            setTimeout(() => errorCard.classList.remove('alert-shake'), 500);
        }

        function clearErrors() {
            const errorCard = document.getElementById('error-log-card');
            errorCard.classList.remove('card-error', 'active');
        }

        // ============================================
        // Demo Controls
        // ============================================
        function triggerLeak() {
            fetch('/demo/trigger-leak', { method: 'POST' })
                .then(res => res.json())
                .then(data => console.log('Leak triggered:', data))
                .catch(err => console.error('Error triggering leak:', err));
        }

        function triggerBlockage() {
            fetch('/demo/trigger-blockage', { method: 'POST' })
                .then(res => res.json())
                .then(data => console.log('Blockage triggered:', data))
                .catch(err => console.error('Error triggering blockage:', err));
        }

        function resetDemo() {
            fetch('/demo/reset', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    console.log('Demo reset:', data);
                    fetchSystemState();
                    fetchDetectionStatus();
                    fetchErrors();
                })
                .catch(err => console.error('Error resetting demo:', err));
        }

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchSystemState();
            fetchDetectionStatus();
            fetchErrors();

            // Periodic updates
            setInterval(fetchSystemState, 2000);
            setInterval(fetchDetectionStatus, 1000);
            setInterval(fetchErrors, 3000);
        });
    </script>
</body>

</html>