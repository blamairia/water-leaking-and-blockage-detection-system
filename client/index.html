<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Flow Monitoring System</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {packages: ['corechart', 'gauge', 'annotationchart']});
    </script>
    <style>
        body {
            padding-top: 20px;
        }
        .chart-container {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-4">
            <h1>Water Flow Monitoring System</h1>
        </header>

        <!-- Sensor 1 -->
        <section id="sensor1-data" class="chart-container">
            <h2>Sensor 1</h2>
            <div class="row">
                <div class="col-md-4">
                    <h4>Real-Time Flow Rate</h4>
                    <div id="gauge-flowmeter1"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Volume</h4>
                    <div id="gauge-volume1"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Pulse Count</h4>
                    <div id="gauge-pulse1"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Annotation Chart - Pulse Counts</h4>
                    <div id="annotation-chart1"></div>
                </div>
                <div class="col-md-6">
                    <h4>Line Chart - Flow Rates</h4>
                    <div id="line-chart1-flow"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Line Chart - Volume</h4>
                    <div id="line-chart1-volume"></div>
                </div>
                <div class="col-md-6">
                    <h4>Area Chart - Cumulative Volume</h4>
                    <div id="area-chart1"></div>
                </div>
            </div>
        </section>

        <!-- Sensor 2 -->
        <section id="sensor2-data" class="chart-container">
            <h2>Sensor 2</h2>
            <div class="row">
                <div class="col-md-4">
                    <h4>Real-Time Flow Rate</h4>
                    <div id="gauge-flowmeter2"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Volume</h4>
                    <div id="gauge-volume2"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Pulse Count</h4>
                    <div id="gauge-pulse2"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Annotation Chart - Pulse Counts</h4>
                    <div id="annotation-chart2"></div>
                </div>
                <div class="col-md-6">
                    <h4>Line Chart - Flow Rates</h4>
                    <div id="line-chart2-flow"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Line Chart - Volume</h4>
                    <div id="line-chart2-volume"></div>
                </div>
                <div class="col-md-6">
                    <h4>Area Chart - Cumulative Volume</h4>
                    <div id="area-chart2"></div>
                </div>
            </div>
        </section>

        <!-- Sensor 3 -->
        <section id="sensor3-data" class="chart-container">
            <h2>Sensor 3</h2>
            <div class="row">
                <div class="col-md-4">
                    <h4>Real-Time Flow Rate</h4>
                    <div id="gauge-flowmeter3"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Volume</h4>
                    <div id="gauge-volume3"></div>
                </div>
                <div class="col-md-4">
                    <h4>Real-Time Pulse Count</h4>
                    <div id="gauge-pulse3"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Annotation Chart - Pulse Counts</h4>
                    <div id="annotation-chart3"></div>
                </div>
                <div class="col-md-6">
                    <h4>Line Chart - Flow Rates</h4>
                    <div id="line-chart3-flow"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Line Chart - Volume</h4>
                    <div id="line-chart3-volume"></div>
                </div>
                <div class="col-md-6">
                    <h4>Area Chart - Cumulative Volume</h4>
                    <div id="area-chart3"></div>
                </div>
            </div>
        </section>

        <!-- Median Values -->
        <section id="median-data" class="chart-container">
            <h2>Median Values</h2>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Annotation Chart - Median Pulse Counts</h4>
                    <div id="annotation-chart-median-pulse"></div>
                </div>
                <div class="col-md-6">
                    <h4>Line Chart - Median Flow Rates</h4>
                    <div id="line-chart-median-flow"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Line Chart - Median Volume</h4>
                    <div id="line-chart-median-volume"></div>
                </div>
                <div class="col-md-6">
                    <h4>Area Chart - Median Cumulative Volume</h4>
                    <div id="area-chart-median"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        google.charts.setOnLoadCallback(initialize);

        function initialize() {
            drawGaugeCharts();
            drawHistoricalCharts();
            drawMedianCharts();
            const socket = io();

            // Listen for real-time data
            socket.on('realtime-data', (data) => {
                updateGaugeChart(data);
            });

            // Update the charts every 10 seconds
            setInterval(drawGaugeCharts, 10000);
        }

        function drawGaugeCharts() {
            fetch('/realtime/flow_rates/1')
                .then(response => response.json())
                .then(data => {
                    var flowMeter1Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Flow Rate', data[0].flow_rate]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-flowmeter1'));
                    chart.draw(flowMeter1Data, options);
                });

            fetch('/realtime/flow_rates/2')
                .then(response => response.json())
                .then(data => {
                    var flowMeter2Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Flow Rate', data[0].flow_rate]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-flowmeter2'));
                    chart.draw(flowMeter2Data, options);
                });

            fetch('/realtime/flow_rates/3')
                .then(response => response.json())
                .then(data => {
                    var flowMeter3Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Flow Rate', data[0].flow_rate]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-flowmeter3'));
                    chart.draw(flowMeter3Data, options);
                });

            fetch('/realtime/volumes/1')
                .then(response => response.json())
                .then(data => {
                    var volume1Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Volume', data[0].volume]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-volume1'));
                    chart.draw(volume1Data, options);
                });

            fetch('/realtime/volumes/2')
                .then(response => response.json())
                .then(data => {
                    var volume2Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Volume', data[0].volume]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-volume2'));
                    chart.draw(volume2Data, options);
                });

            fetch('/realtime/volumes/3')
                .then(response => response.json())
                .then(data => {
                    var volume3Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Volume', data[0].volume]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-volume3'));
                    chart.draw(volume3Data, options);
                });

            fetch('/realtime/pulses/1')
                .then(response => response.json())
                .then(data => {
                    var pulse1Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Pulse Count', data[0].pulse_count]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-pulse1'));
                    chart.draw(pulse1Data, options);
                });

            fetch('/realtime/pulses/2')
                .then(response => response.json())
                .then(data => {
                    var pulse2Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Pulse Count', data[0].pulse_count]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-pulse2'));
                    chart.draw(pulse2Data, options);
                });

            fetch('/realtime/pulses/3')
                .then(response => response.json())
                .then(data => {
                    var pulse3Data = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Pulse Count', data[0].pulse_count]
                    ]);
                    var options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };
                    var chart = new google.visualization.Gauge(document.getElementById('gauge-pulse3'));
                    chart.draw(pulse3Data, options);
                });
        }

        function updateGaugeChart(data) {
            const sensorId = data.sensorId + 1; // Sensor IDs are 1-indexed in the DOM
            const flowRateElementId = `gauge-flowmeter${sensorId}`;
            const volumeElementId = `gauge-volume${sensorId}`;
            const pulseElementId = `gauge-pulse${sensorId}`;

            const flowRateData = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['Flow Rate', data.flowRate]
            ]);
            const volumeData = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['Volume', data.volume]
            ]);
            const pulseData = google.visualization.arrayToDataTable([
                ['Label', 'Value'],
                ['Pulse Count', data.pulseCount]
            ]);

            const options = { width: 400, height: 120, redFrom: 90, redTo: 100, yellowFrom: 75, yellowTo: 90, minorTicks: 5 };

            const flowRateChart = new google.visualization.Gauge(document.getElementById(flowRateElementId));
            flowRateChart.draw(flowRateData, options);

            const volumeChart = new google.visualization.Gauge(document.getElementById(volumeElementId));
            volumeChart.draw(volumeData, options);

            const pulseChart = new google.visualization.Gauge(document.getElementById(pulseElementId));
            pulseChart.draw(pulseData, options);
        }

        function drawHistoricalCharts() {
            const date = '2024-06-18'; // Example date

            fetch(`/history/pulses/0?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var annotationData = new google.visualization.DataTable();
                    annotationData.addColumn('date', 'Date');
                    annotationData.addColumn('number', 'Pulse Count');
                    data.forEach(row => {
                        annotationData.addRow([new Date(row.timestamp), row.pulse_count]);
                    });
                    var chart = new google.visualization.AnnotationChart(document.getElementById('annotation-chart1'));
                    var options = { displayAnnotations: true };
                    chart.draw(annotationData, options);
                });

            fetch(`/history/flow_rates/0?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Flow Rate');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.flow_rate]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart1-flow'));
                    var options = { title: 'Flow Rate Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/0?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Volume');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.volume]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart1-volume'));
                    var options = { title: 'Volume Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/0?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var areaData = new google.visualization.DataTable();
                    areaData.addColumn('date', 'Date');
                    areaData.addColumn('number', 'Cumulative Volume');
                    var cumulativeVolume = 0;
                    data.forEach(row => {
                        cumulativeVolume += row.volume;
                        areaData.addRow([new Date(row.timestamp), cumulativeVolume]);
                    });
                    var chart = new google.visualization.AreaChart(document.getElementById('area-chart1'));
                    var options = { title: 'Cumulative Volume Over Time', hAxis: {title: 'Time'}, vAxis: {title: 'Volume'}, legend: {position: 'bottom'} };
                    chart.draw(areaData, options);
                });

            // Repeat for Sensor 2
            fetch(`/history/pulses/1?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var annotationData = new google.visualization.DataTable();
                    annotationData.addColumn('date', 'Date');
                    annotationData.addColumn('number', 'Pulse Count');
                    data.forEach(row => {
                        annotationData.addRow([new Date(row.timestamp), row.pulse_count]);
                    });
                    var chart = new google.visualization.AnnotationChart(document.getElementById('annotation-chart2'));
                    var options = { displayAnnotations: true };
                    chart.draw(annotationData, options);
                });

            fetch(`/history/flow_rates/1?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Flow Rate');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.flow_rate]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart2-flow'));
                    var options = { title: 'Flow Rate Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/1?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Volume');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.volume]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart2-volume'));
                    var options = { title: 'Volume Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/1?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var areaData = new google.visualization.DataTable();
                    areaData.addColumn('date', 'Date');
                    areaData.addColumn('number', 'Cumulative Volume');
                    var cumulativeVolume = 0;
                    data.forEach(row => {
                        cumulativeVolume += row.volume;
                        areaData.addRow([new Date(row.timestamp), cumulativeVolume]);
                    });
                    var chart = new google.visualization.AreaChart(document.getElementById('area-chart2'));
                    var options = { title: 'Cumulative Volume Over Time', hAxis: {title: 'Time'}, vAxis: {title: 'Volume'}, legend: {position: 'bottom'} };
                    chart.draw(areaData, options);
                });

            // Repeat for Sensor 3
            fetch(`/history/pulses/2?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var annotationData = new google.visualization.DataTable();
                    annotationData.addColumn('date', 'Date');
                    annotationData.addColumn('number', 'Pulse Count');
                    data.forEach(row => {
                        annotationData.addRow([new Date(row.timestamp), row.pulse_count]);
                    });
                    var chart = new google.visualization.AnnotationChart(document.getElementById('annotation-chart3'));
                    var options = { displayAnnotations: true };
                    chart.draw(annotationData, options);
                });

            fetch(`/history/flow_rates/2?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Flow Rate');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.flow_rate]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart3-flow'));
                    var options = { title: 'Flow Rate Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/2?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Volume');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.volume]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart3-volume'));
                    var options = { title: 'Volume Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/history/volumes/2?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var areaData = new google.visualization.DataTable();
                    areaData.addColumn('date', 'Date');
                    areaData.addColumn('number', 'Cumulative Volume');
                    var cumulativeVolume = 0;
                    data.forEach(row => {
                        cumulativeVolume += row.volume;
                        areaData.addRow([new Date(row.timestamp), cumulativeVolume]);
                    });
                    var chart = new google.visualization.AreaChart(document.getElementById('area-chart3'));
                    var options = { title: 'Cumulative Volume Over Time', hAxis: {title: 'Time'}, vAxis: {title: 'Volume'}, legend: {position: 'bottom'} };
                    chart.draw(areaData, options);
                });
        }

        function drawMedianCharts() {
            const date = '2024-06-18'; // Example date

            fetch(`/realtime/median_pulses`)
                .then(response => response.json())
                .then(data => {
                    var annotationData = new google.visualization.DataTable();
                    annotationData.addColumn('date', 'Date');
                    annotationData.addColumn('number', 'Median Pulse Count');
                    data.forEach(row => {
                        annotationData.addRow([new Date(row.timestamp), row.median_pulse_count]);
                    });
                    var chart = new google.visualization.AnnotationChart(document.getElementById('annotation-chart-median-pulse'));
                    var options = { displayAnnotations: true };
                    chart.draw(annotationData, options);
                });

            fetch(`/realtime/median_flow_rates`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Median Flow Rate');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.median_flow_rate]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart-median-flow'));
                    var options = { title: 'Median Flow Rate Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/realtime/median_volumes`)
                .then(response => response.json())
                .then(data => {
                    var lineData = new google.visualization.DataTable();
                    lineData.addColumn('date', 'Date');
                    lineData.addColumn('number', 'Median Volume');
                    data.forEach(row => {
                        lineData.addRow([new Date(row.timestamp), row.median_volume]);
                    });
                    var chart = new google.visualization.LineChart(document.getElementById('line-chart-median-volume'));
                    var options = { title: 'Median Volume Over Time', curveType: 'function', legend: { position: 'bottom' } };
                    chart.draw(lineData, options);
                });

            fetch(`/realtime/median_volumes`)
                .then(response => response.json())
                .then(data => {
                    var areaData = new google.visualization.DataTable();
                    areaData.addColumn('date', 'Date');
                    areaData.addColumn('number', 'Median Cumulative Volume');
                    var cumulativeVolume = 0;
                    data.forEach(row => {
                        cumulativeVolume += row.median_volume;
                        areaData.addRow([new Date(row.timestamp), cumulativeVolume]);
                    });
                    var chart = new google.visualization.AreaChart(document.getElementById('area-chart-median'));
                    var options = { title: 'Median Cumulative Volume Over Time', hAxis: {title: 'Time'}, vAxis: {title: 'Volume'}, legend: {position: 'bottom'} };
                    chart.draw(areaData, options);
                });
        }
    </script>
</body>
</html>
